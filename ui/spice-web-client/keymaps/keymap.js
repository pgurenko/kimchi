wdi.keyShortcutsHandled = {
    CTRLV: 0
}

wdi.Keymap = {
    defaultCodes: {
        "Backquote": [0x29, 0, 0, 0],
        "Backslash": [0x2B, 0, 0, 0],
        "Backspace": [0x0E, 0, 0, 0],
        "BracketLeft": [0x1A, 0, 0, 0],
        "BracketRight": [0x1B, 0, 0, 0],
        "Comma": [0x33, 0, 0, 0],
        "Digit0": [0x0B, 0, 0, 0],
        "Digit1": [0x02, 0, 0, 0],
        "Digit2": [0x03, 0, 0, 0],
        "Digit3": [0x04, 0, 0, 0],
        "Digit4": [0x05, 0, 0, 0],
        "Digit5": [0x06, 0, 0, 0],
        "Digit6": [0x07, 0, 0, 0],
        "Digit7": [0x08, 0, 0, 0],
        "Digit8": [0x09, 0, 0, 0],
        "Digit9": [0x0A, 0, 0, 0],
        "Equal": [0x0D, 0, 0, 0],
        "IntlBackslash": [0x56, 0, 0, 0],
        "KeyA": [0x1E, 0, 0, 0],
        "KeyB": [0x30, 0, 0, 0],
        "KeyC": [0x2E, 0, 0, 0],
        "KeyD": [0x20, 0, 0, 0],
        "KeyE": [0x12, 0, 0, 0],
        "KeyF": [0x21, 0, 0, 0],
        "KeyG": [0x22, 0, 0, 0],
        "KeyH": [0x23, 0, 0, 0],
        "KeyI": [0x17, 0, 0, 0],
        "KeyJ": [0x24, 0, 0, 0],
        "KeyK": [0x25, 0, 0, 0],
        "KeyL": [0x26, 0, 0, 0],
        "KeyM": [0x32, 0, 0, 0],
        "KeyN": [0x31, 0, 0, 0],
        "KeyO": [0x18, 0, 0, 0],
        "KeyP": [0x19, 0, 0, 0],
        "KeyQ": [0x10, 0, 0, 0],
        "KeyR": [0x13, 0, 0, 0],
        "KeyS": [0x1F, 0, 0, 0],
        "KeyT": [0x14, 0, 0, 0],
        "KeyU": [0x16, 0, 0, 0],
        "KeyV": [0x2F, 0, 0, 0],
        "KeyW": [0x11, 0, 0, 0],
        "KeyX": [0x2D, 0, 0, 0],
        "KeyY": [0x15, 0, 0, 0],
        "KeyZ": [0x2C, 0, 0, 0],
        "Minus": [0x0C, 0, 0, 0],
        "Period": [0x34, 0, 0, 0],
        "Quote": [0x28, 0, 0, 0],
        "Semicolon": [0x27, 0, 0, 0],
        "Slash": [0x35, 0, 0, 0],
        "AltLeft": [0x38, 0, 0, 0],
        "AltRight": [0xE0, 0x38, 0, 0],
        "CapsLock": [0x3A, 0, 0, 0],
        "ContextMenu": [0xE0, 0x5D, 0, 0],
        "ControlLeft": [0x1D, 0, 0, 0],
        "ControlRight": [0xE0, 0x1D, 0, 0],
        "Enter": [0x1C, 0, 0, 0],
        "MetaLeft": [0xE0, 0x5B, 0, 0],
        "MetaRight": [0xE0, 0X5C, 0, 0],
        "OSLeft": [0xE0, 0x5B, 0, 0],
        "OSRight": [0xE0, 0X5C, 0, 0],
        "ShiftLeft": [0x2A, 0, 0, 0],
        "ShiftRight": [0x36, 0, 0, 0],
        "Space": [0x39, 0, 0, 0],
        "Tab": [0x0F, 0, 0, 0],
        "Delete": [0xE0, 0x53, 0, 0],
        "End": [0xE0, 0x4F, 0, 0],
        "Home": [0xE0, 0x47, 0, 0],
        "Insert": [0xE0, 0x52, 0, 0],
        "PageDown": [0xE0, 0x51, 0, 0],
        "PageUp": [0xE0, 0x49, 0, 0],
        "ArrowDown": [0xE0, 0x50, 0, 0],
        "ArrowLeft": [0xE0, 0x4B, 0, 0],
        "ArrowRight": [0xE0, 0x4D, 0, 0],
        "ArrowUp": [0xE0, 0x48, 0, 0],
        "NumLock": [0x45, 0, 0, 0],
        "Numpad0": [0x52, 0, 0, 0],
        "Numpad1": [0x4F, 0, 0, 0],
        "Numpad2": [0x50, 0, 0, 0],
        "Numpad3": [0x51, 0, 0, 0],
        "Numpad4": [0x4B, 0, 0, 0],
        "Numpad5": [0x4C, 0, 0, 0],
        "Numpad6": [0x4D, 0, 0, 0],
        "Numpad7": [0x47, 0, 0, 0],
        "Numpad8": [0x48, 0, 0, 0],
        "Numpad9": [0x49, 0, 0, 0],
        "NumpadAdd": [0x4E, 0, 0, 0],
        "NumpadDecimal": [0x53, 0, 0, 0],
        "NumpadDivide": [0xE0, 0x35, 0, 0],
        "NumpadEnter": [0xE0, 0x1C, 0, 0],
        "NumpadMultiply": [0x37, 0, 0, 0],
        "NumpadSubtract": [0x4A, 0, 0, 0],
        "Escape": [0x01, 0, 0, 0],
        "F1": [0x3B, 0, 0, 0],
        "F2": [0x3C, 0, 0, 0],
        "F3": [0x3D, 0, 0, 0],
        "F4": [0x3E, 0, 0, 0],
        "F5": [0x3F, 0, 0, 0],
        "F6": [0x40, 0, 0, 0],
        "F7": [0x41, 0, 0, 0],
        "F8": [0x42, 0, 0, 0],
        "F9": [0x43, 0, 0, 0],
        "F10": [0x44, 0, 0, 0],
        "F11": [0x57, 0, 0, 0],
        "F12": [0x58, 0, 0, 0],
        "PrintScreen": [0xE0, 0x2A, 0xE0, 0x37],
        "ScrollLock": [0x46, 0, 0, 0],
        //"Pause": [0xE0, 0, 0, 0],
        //"BrowserBack": [0xE0, 0, 0, 0],
        //"BrowserFavorites": [0xE0, 0, 0, 0],
        //"BrowserForward": [0xE0, 0, 0, 0],
        //"BrowserHome": [0xE0, 0, 0, 0],
        //"BrowserRefresh": [0xE0, 0, 0, 0],
        //"BrowserSearch": [0xE0, 0, 0, 0],
        //"BrowserStop": [0xE0, 0, 0, 0],
        //"Eject": [0xE0, 0, 0, 0],
        //"LaunchApp1": [0xE0, 0, 0, 0],
        //"LaunchApp2": [0xE0, 0, 0, 0],
        //"LaunchMail": [0xE0, 0, 0, 0],
        //"MediaPlayPause": [0xE0, 0, 0, 0],
        //"MediaSelect": [0xE0, 0, 0, 0],
        //"MediaStop": [0xE0, 0, 0, 0],
        //"MediaTrackNext": [0xE0, 0, 0, 0],
        //"MediaTrackPrevious": [0xE0, 0, 0, 0],
        //"Power": [0xE0, 0, 0, 0],
        //"Sleep": [0xE0, 0, 0, 0],
        //"AudioVolumeDown": [0xE0, 0, 0, 0],
        //"AudioVolumeMute": [0xE0, 0, 0, 0],
        //"AudioVolumeUp": [0xE0, 0, 0, 0],
        //"WakeUp": [0xE0, 0, 0, 0],
    },
    keymap: {},
    ctrlKeymap: {},
    charmap: {},
    pressedKeyMap: [],
    ctrlPressed: false,
    twoBytesScanCodes: [0x5B, 0xDB, /*0x38, 0xB8,*/ 0x5C, 0xDC, 0x1D, 0x9D, 0x5D, 0xDD, 0x52, 0xD2, 0x53, 0xD3, 0x4B, 0xCB, 0x47, 0xC9, 0x4F, 0xCF, 0x48, 0xC8, 0x50, 0xD0, 0x49, 0xC9, 0x51, 0xD1, 0x4D, 0xCD, 0x1C, 0x9C],

    loadKeyMap: function(lang) {
        try {
            layout = {
                'es': 'ES',
                'en': 'US',
                'fr': 'FR',
                'ru': 'RU'
            }[lang]
            this.keymap = wdi['Keymap' + layout].getKeymap();
            this.ctrlKeymap = wdi['Keymap' + layout].getCtrlKeymap();
            this.reservedCtrlKeymap =  wdi['Keymap' + layout].getReservedCtrlKeymap();
            this.charmap = wdi['Keymap' + layout].getCharmap();
        } catch(e) {
			this.keymap = wdi.KeymapES.getKeymap();
            this.ctrlKeymap = wdi.KeymapES.getCtrlKeymap();
            this.reservedCtrlKeymap =  wdi.KeymapES.getReservedCtrlKeymap();
            this.charmap = wdi.KeymapES.getCharmap();
		}
    },

    isInKeymap: function(keycode) {
        if (this.keymap[keycode] === undefined) return false;
        else return true;
    },

    /**
     * Returns the associated spice key code from the given browser keyboard event
     * @param e
     * @returns {*}
     */
    getScanCodes: function(e, omitCtrl, type) {
        if ('originalEvent' in e && 'code' in e.originalEvent) {
            code = e.originalEvent.code;
            if (code != "" && code != 'Unidentified') {
                console.log("Use KeyboardEvent.code = " + code + ", " + type);
                result = []
                scanCodes = this.defaultCodes[code].slice();
                if (type != 'keydown' && type != 'keypress') {
                    if (scanCodes[0] == 0xE0) {
                        scanCodes[1] = scanCodes[1] | 0x80;
                    } else {
                        scanCodes[0] = scanCodes[0] | 0x80;
                    }
                }
                result.push(scanCodes.slice());
                return result;
            }
        }
        if (e['hasScanCode']) {
            return e['scanCode'];
        } else if (!omitCtrl && this.handledByCtrlKeyCode(type, e['keyCode'], e['generated'])) {// before doing anything else we check if the event about to be handled has to be intercepted
            scanCodes = this.getScanCodeFromKeyCode(e['keyCode'], type, this.ctrlKeymap, this.reservedCtrlKeymap);
            this.pressedKeyMap[e['keyCode']] = scanCodes;
            console.log("handleByCtrl: keycode=" + e['keyCode'] + " scancodes=" + scanCodes);
            if (scanCodes.length > 0) {
                if (type == 'keydown' || type == 'keypress') {
                    return [[224, 29, 0], scanCodes[0]];
                } else {
                    return [[224, 157, 0], scanCodes[0]];
                }
            } else {
                return scanCodes;
            }
        } else if (!omitCtrl && this.handledByPreviousCtrlKeyCode(type, e['keyCode'], e['generated'])) {
            scanCodes = this.pressedKeyMap[e['keyCode']];
            scanCodes[0][0] = scanCodes[0][0] | 0x80;
            console.log("handleByPreviousCtrl: keycode=" + e['keyCode'] + " scancodes=" + scanCodes);
            delete this.pressedKeyMap[e['keyCode']];
            return scanCodes;
        } else if (this.handledByCharmap(e['type'])) {
            return this.getScanCodesFromCharCode(e['charCode']);
        } else if (this.handledByNormalKeyCode(type, e['keyCode'], e['generated'])) {
            additionalKeymap = { };
            additionalKeymap[76] = 0x26;
            return this.getScanCodeFromKeyCode(e['keyCode'], type, this.keymap, additionalKeymap);
        } else {
            return [];
        }
    },

    getScanCodeFromKeyCode: function(keyCode, type, keymap, additionalKeymap) {
        this.controlPressed(keyCode, type);
        var key = null;
        if(keyCode in keymap) {
            key = keymap[keyCode];
        } else {
            key = additionalKeymap[keyCode];
        }
        if (key === undefined) return [];
        if (key < 0x100) {
            if (type == 'keydown') {
                return [this.makeKeymap(key)];
            } else if (type == 'keyup') {
                return [this.makeKeymap(key | 0x80)];
            }
        } else {
            var code = 0;
            if (type == 'keydown') {
                code = (0xe0 | ((key - 0x100) << 8));
            } else if (type == 'keyup') {
                code = (0x80e0 | ((key - 0x100) << 8));
            }
            var firstbyte = (code & 0x00FF);
            var secondbyte = (code & 0xFF00) >> 8;
            return [[firstbyte, secondbyte, 0, 0]];
        }
        return key;
    },

    controlPressed: function(keyCode, type) {
        if (keyCode === 17 /*|| keyCode === 91*/) {  // Ctrl or CMD key
            if (type === 'keydown') this.ctrlPressed = true;
            else if (type === 'keyup') this.ctrlPressed = false;
        }
    },

    handledByCtrlKeyCode: function(type, keyCode, generated) {
        if (type === 'keydown' || type === 'keyup' || type === 'keypress') {
            if (this.ctrlPressed) {
                if (type === 'keypress') {
                    return true;
                }

                if (this.ctrlKeymap[keyCode]) {
                    return true;  // is the second key in a keyboard shortcut (i.e. the x in Ctrl+x)
                }

                //check if the event is a fake event generated from our gui or programatically
                if(generated && this.reservedCtrlKeymap[keyCode]) {
                    return true;
                }
            }
        }
        return false;
    },

    handledByPreviousCtrlKeyCode: function(type, keyCode, generated) {
        if (type === 'keyup') {
            if (!this.ctrlPressed) {
                if (this.pressedKeyMap[keyCode] != undefined) {
                    return true;
                }
            }
        }
        return false;
    },

    handledByNormalKeyCode: function(type, keyCode, generated) {
        if (type === 'keydown' || type === 'keyup') {
            if (this.keymap[keyCode]) {
                return true;
            } else if (generated && keyCode == 76) {
                /* Special case to support generated Win+L */
                return true;
            }
        }
        return false;
    },

    handledByCharmap: function(type) {
        if (type === 'inputmanager') return true;
        else return false;
    },

    getScanCodesFromCharCode: function(charCode) {
        var scanCode = this.charmap[String.fromCharCode(charCode)];
        if (scanCode === undefined) scanCode = [];
        return scanCode;
    },

    makeKeymap: function(scancode) {
        if ($.inArray(scancode, this.twoBytesScanCodes) != -1) {
            return [0xE0, scancode, 0, 0];
        } else {
            return [scancode, 0, 0];
        }
    }
}
